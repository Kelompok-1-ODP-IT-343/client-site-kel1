# name: Build and Push to Docker Hub

# on:
#   push:
#     branches: ["master"]
#     tags: ["v*"]

# jobs:
#   docker:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: read
#       packages: write

#     steps:
#       # [1] Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # [2] Setup Node.js
#       - name: Setup Node (for caching and potential pre-steps)
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#           # cache: "npm"
      
#       # [3] Install dependencies
#       # - name: Install dependencies
#       #   run: npm ci

#       # [4] Lint and Unit Test (optional but recommended)
#       # - name: Run Linter
#       #   run: npm run lint
#       # - name: Run Unit Tests with Coverage
#       #   run: npm test -- --coverage

#       # [5] SonarCloud Scan (Code Quality)
#       # - name: SonarCloud Scan
#       #   uses: SonarSource/sonarcloud-github-action@v2
#       #   env:
#       #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#       #   with:
#       #     args: >
#       #       -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
#       #       -Dsonar.organization=${{ secrets.SONAR_ORG }}
#       #       -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

#       # [6] Trivy Scan (Filesystem)
#       # - name: Trivy FS Scan (Project Files)
#       #   uses: aquasecurity/trivy-action@0.28.0
#       #   with:
#       #     scan-type: 'fs'
#       #     scanners: 'vuln,secret,misconfig'
#       #     ignore-unfixed: true
#       #     severity: 'HIGH,CRITICAL'
#       #     exit-code: '1'
#       #     skip-dirs: 'node_modules,.git'

#       # [7] Extract Docker metadata
#       - name: Extract metadata (tags, labels) for Docker
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ secrets.DOCKERHUB_USERNAME }}/client-side-kel1
#           tags: |
#             type=ref,event=branch
#             type=ref,event=tag
#             type=sha

#       # [8] Setup Docker Build Environment
#       - name: Set up QEMU
#         uses: docker/setup-qemu-action@v3

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       # [9] Docker Hub Login
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       # [10] Trivy Scan (Docker Image)
#       # - name: Trivy Image Scan
#       #   uses: aquasecurity/trivy-action@0.28.0
#       #   with:
#       #     image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/client-side-kel1:latest
#       #     format: 'table'
#       #     ignore-unfixed: true
#       #     severity: 'HIGH,CRITICAL'
#       #     exit-code: '1'

#       # [11] Build and Push Docker Image
#       - name: Build and push
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./Dockerfile
#           push: true
#           platforms: linux/amd64,linux/arm64
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}
#           cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/client-side-kel1:buildcache
#           cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/client-side-kel1:buildcache,mode=max
